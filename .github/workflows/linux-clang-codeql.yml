name: "Static Code Analysis"

on:
  push:
    branches: [ "*" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '26 0 * * 5'

jobs:
  analyze:
    name: 'Analyze C++'
    runs-on: 'ubuntu-24.04'
    timeout-minutes: 360
    env:
      VCPKG_INSTALLATION_ROOT: "${{ github.workspace }}/vcpkg"
      VCPKG_DEFAULT_BINARY_CACHE: "${{ github.workspace }}/vcpkg/bincache"
      VCPKG_DEFAULT_TRIPLET: "x64-linux"
      VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"
      VCPKG_FEATURE_FLAGS: dependencygraph
      PRESET_NAME: "linux-release"
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    permissions:
      security-events: write
      contents: write
      packages: read

    steps:
    - name: 'Checkout repository'
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt install cppcheck -y

    - name: "Create directory '${{ env.VCPKG_DEFAULT_BINARY_CACHE }}'"
      run: mkdir -p $VCPKG_DEFAULT_BINARY_CACHE
      shell: bash

      # Setup the build machine with the most recent versions of CMake and Ninja. Both are cached if not already
    - uses: lukka/get-cmake@latest
    - uses: lukka/run-vcpkg@v11.5
      with:
        vcpkgJsonGlob: '**/vcpkg.json'

      # Initializes the CodeQL tools for scanning.
    - name: 'Initialize CodeQL'
      uses: github/codeql-action/init@v3
      with:
        config-file: tools/codeql/config_scan_all.yml
        languages: 'c-cpp'
        build-mode: 'manual'

    - shell: bash
      run: |
        scripts/build_preset.sh --preset linux-release --configure --build

    - name: 'Perform CodeQL Analysis'
      uses: github/codeql-action/analyze@v3
      with:
        category: cpp
        output: sarif-results
        upload: failure-only

    - shell: bash
      run: |
        ls -lah sarif-results

    - name: 'Filter vcpkg lib code from results'
      uses: advanced-security/filter-sarif@v1
      with:
        patterns: |
          -**/vcpkg*/**/*.*
        input: sarif-results/cpp.sarif
        output: sarif-results/cpp.sarif

    - name: Upload SARIF
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: sarif-results/cpp.sarif

    - name: Upload loc as a Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: sarif-results
        path: sarif-results
        retention-days: 1
